<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.6" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="32x32" href="https://i.loli.net/2017/12/11/5a2ded5692edd.jpg?v=6.0.6">


  <link rel="icon" type="image/png" sizes="16x16" href="https://i.loli.net/2017/12/11/5a2ded5692edd.jpg?v=6.0.6">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.6" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.0.6',
    sidebar: {"position":"left","display":"post","offset":15,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="参考教程Tutorial 40: Shadow Mapping 阴影技术：Shadow Map 初探 Tutorial 16 : Shadow mapping 学习记录&amp;emsp;&amp;emsp;这篇文章中我们介绍在 DX11 中实现阴影映射。">
<meta name="keywords" content="Computer graphics,DirectX">
<meta property="og:type" content="article">
<meta property="og:title" content="【DirectX】42-阴影映射">
<meta property="og:url" content="https://blog.ksgin.com/2018/04/24/【DirectX】42-阴影映射/index.html">
<meta property="og:site_name" content="杨帆博客">
<meta property="og:description" content="参考教程Tutorial 40: Shadow Mapping 阴影技术：Shadow Map 初探 Tutorial 16 : Shadow mapping 学习记录&amp;emsp;&amp;emsp;这篇文章中我们介绍在 DX11 中实现阴影映射。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://image.ibb.co/mY38Gx/image.png">
<meta property="og:image" content="https://image.ibb.co/ezrs9H/image.png">
<meta property="og:updated_time" content="2018-08-22T01:38:23.286Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【DirectX】42-阴影映射">
<meta name="twitter:description" content="参考教程Tutorial 40: Shadow Mapping 阴影技术：Shadow Map 初探 Tutorial 16 : Shadow mapping 学习记录&amp;emsp;&amp;emsp;这篇文章中我们介绍在 DX11 中实现阴影映射。">
<meta name="twitter:image" content="https://image.ibb.co/mY38Gx/image.png">








<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>【DirectX】42-阴影映射 | 杨帆博客</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">杨帆博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">你想开发游戏还是改变世界？</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
</li>

      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.ksgin.com/2018/04/24/【DirectX】42-阴影映射/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="KsGin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://i.loli.net/2017/12/11/5a2ded5692edd.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨帆博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">【DirectX】42-阴影映射</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-24T11:26:31+08:00">2018-04-24</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于：</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-08-22T09:38:23+08:00">2018-08-22</time>
            
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="参考教程"><a href="#参考教程" class="headerlink" title="参考教程"></a>参考教程</h4><p><a href="http://www.rastertek.com/dx11tut40.html" target="_blank" rel="noopener">Tutorial 40: Shadow Mapping</a></p>
<p><a href="https://blog.csdn.net/spracle/article/details/20077425" target="_blank" rel="noopener">阴影技术：Shadow Map 初探</a></p>
<p><a href="http://www.opengl-tutorial.org/cn/intermediate-tutorials/tutorial-16-shadow-mapping/" target="_blank" rel="noopener">Tutorial 16 : Shadow mapping</a></p>
<h4 id="学习记录"><a href="#学习记录" class="headerlink" title="学习记录"></a>学习记录</h4><p>&emsp;&emsp;这篇文章中我们介绍在 DX11 中实现阴影映射。</p>
<a id="more"></a>
<p>&emsp;&emsp;阴影的示意图如下：</p>
<p><img src="https://image.ibb.co/mY38Gx/image.png" alt="1"></p>
<blockquote>
<p>&emsp;&emsp;The basic shadowmap algorithm consists in two passes. First, the scene is rendered from the point of view of the light. Only the depth of each fragment is computed. Next, the scene is rendered as usual, but with an extra test to see it the current fragment is in the shadow.</p>
<p>&emsp;&emsp;The “being in the shadow” test is actually quite simple. If the current sample is further from the light than the shadowmap at the same point, this means that the scene contains an object that is closer to the light. In other words, the current fragment is in the shadow.</p>
</blockquote>
<p>&emsp;&emsp;我们对于动态阴影的渲染可以分为以下两个部分：1. 以光的视角来渲染一张纹理，这张纹理上存储了像素点的深度，我们称它为深度图。2. 正常渲染，不同的是我们在像素着色器中判断当前像素的深度，如果它大于深度图中存储的深度，则它处于阴影中。</p>
<p>&emsp;&emsp;这么想的话其实并不复杂，我们首先使用 RenderToTexture 技术将像素的深度存入我们的深度图，我们需要一个 <code>DepthShaderClass</code> 以及对应着色器。由于只是存入深度信息，所以比较简单。</p>
<p>&emsp;&emsp;着色器代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Filename: depth.vs</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////</span></span><br><span class="line"><span class="comment">// GLOBALS //</span></span><br><span class="line"><span class="comment">/////////////</span></span><br><span class="line">cbuffer MatrixBuffer</span><br><span class="line">&#123;</span><br><span class="line">	matrix worldMatrix;</span><br><span class="line">	matrix viewMatrix;</span><br><span class="line">	matrix projectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line"><span class="comment">// TYPEDEFS //</span></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexInputType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float4 position : POSITION;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PixelInputType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float4 depthPosition : TEXTURE0;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Vertex Shader</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="function">PixelInputType <span class="title">DepthVertexShader</span><span class="params">(VertexInputType input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PixelInputType output;  </span><br><span class="line">	<span class="comment">// Change the position vector to be 4 units for proper matrix calculations.</span></span><br><span class="line">    input.position.w = <span class="number">1.0f</span>;</span><br><span class="line">	<span class="comment">// Calculate the position of the vertex against the world, view, and projection matrices.</span></span><br><span class="line">    output.position = mul(input.position, worldMatrix);</span><br><span class="line">    output.position = mul(output.position, viewMatrix);</span><br><span class="line">    output.position = mul(output.position, projectionMatrix);</span><br><span class="line">	<span class="comment">// Store the position value in a second input value for depth value calculations.</span></span><br><span class="line">	output.depthPosition = output.position;	</span><br><span class="line">	<span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Filename: depth.ps</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line"><span class="comment">// TYPEDEFS //</span></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PixelInputType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float4 depthPosition : TEXTURE0;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Pixel Shader</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">float4 DepthPixelShader(PixelInputType input) : SV_TARGET</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">float</span> depthValue;</span><br><span class="line">	float4 color;</span><br><span class="line">	<span class="comment">// Get the depth value of the pixel by dividing the Z pixel depth by the homogeneous W coordinate.</span></span><br><span class="line">	depthValue = input.depthPosition.z / input.depthPosition.w;</span><br><span class="line">	color = float4(depthValue, depthValue, depthValue, <span class="number">1.0f</span>);</span><br><span class="line">	<span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;其对应的 <code>DepthShaderClass</code> 类也比较简单，在此我们贴出声明：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Class name: DepthShaderClass</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DepthShaderClass</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MatrixBufferType</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		DirectX::XMMATRIX world;</span><br><span class="line">		DirectX::XMMATRIX view;</span><br><span class="line">		DirectX::XMMATRIX projection;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	DepthShaderClass();</span><br><span class="line">	DepthShaderClass(<span class="keyword">const</span> DepthShaderClass&amp;);</span><br><span class="line">	~DepthShaderClass();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">(ID3D11Device*, HWND)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Shutdown</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">Render</span><span class="params">(ID3D11DeviceContext*, <span class="keyword">int</span>, DirectX::XMMATRIX, DirectX::XMMATRIX, DirectX::XMMATRIX)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">InitializeShader</span><span class="params">(ID3D11Device*, HWND, CHAR*, CHAR*)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ShutdownShader</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OutputShaderErrorMessage</span><span class="params">(ID3D10Blob*, HWND, CHAR*)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">SetShaderParameters</span><span class="params">(ID3D11DeviceContext*, DirectX::XMMATRIX, DirectX::XMMATRIX, DirectX::XMMATRIX)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">RenderShader</span><span class="params">(ID3D11DeviceContext*, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	ID3D11VertexShader* m_vertexShader;</span><br><span class="line">	ID3D11PixelShader* m_pixelShader;</span><br><span class="line">	ID3D11InputLayout* m_layout;</span><br><span class="line">	ID3D11Buffer* m_matrixBuffer;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;相比较而言，我们需要注意的是 <code>shadow</code> 着色器的内容，如我们上边所言，我们需要使用深度图中的深度进行比较，所以需要计算当前像素相对于光源的深度，在 <code>vertex</code> 中我们完成计算光源坐标以及方向，如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Filename: shadow.vs</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////</span></span><br><span class="line"><span class="comment">// GLOBALS //</span></span><br><span class="line"><span class="comment">/////////////</span></span><br><span class="line">cbuffer MatrixBuffer</span><br><span class="line">&#123;</span><br><span class="line">	matrix worldMatrix;</span><br><span class="line">	matrix viewMatrix;</span><br><span class="line">	matrix projectionMatrix;</span><br><span class="line">	matrix lightViewMatrix;</span><br><span class="line">	matrix lightProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////</span></span><br><span class="line"><span class="comment">// CONSTANT BUFFERS //</span></span><br><span class="line"><span class="comment">//////////////////////</span></span><br><span class="line">cbuffer LightBuffer2</span><br><span class="line">&#123;</span><br><span class="line">    float3 lightPosition;</span><br><span class="line">	<span class="keyword">float</span> padding;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line"><span class="comment">// TYPEDEFS //</span></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexInputType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float4 position : POSITION;</span><br><span class="line">    float2 tex : TEXCOORD0;</span><br><span class="line">	float3 normal : NORMAL;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PixelInputType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float2 tex : TEXCOORD0;</span><br><span class="line">	float3 normal : NORMAL;</span><br><span class="line">    float4 lightViewPosition : TEXCOORD1;</span><br><span class="line">	float3 lightPos : TEXCOORD2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Vertex Shader</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="function">PixelInputType <span class="title">ShadowVertexShader</span><span class="params">(VertexInputType input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PixelInputType output;</span><br><span class="line">	float4 worldPosition;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Change the position vector to be 4 units for proper matrix calculations.</span></span><br><span class="line">    input.position.w = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Calculate the position of the vertex against the world, view, and projection matrices.</span></span><br><span class="line">    output.position = mul(input.position, worldMatrix);</span><br><span class="line">    output.position = mul(output.position, viewMatrix);</span><br><span class="line">    output.position = mul(output.position, projectionMatrix);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Calculate the position of the vertice as viewed by the light source.</span></span><br><span class="line">    output.lightViewPosition = mul(input.position, worldMatrix);</span><br><span class="line">    output.lightViewPosition = mul(output.lightViewPosition, lightViewMatrix);</span><br><span class="line">    output.lightViewPosition = mul(output.lightViewPosition, lightProjectionMatrix);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Store the texture coordinates for the pixel shader.</span></span><br><span class="line">    output.tex = input.tex;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Calculate the normal vector against the world matrix only.</span></span><br><span class="line">    output.normal = mul(input.normal, (float3x3)worldMatrix);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Normalize the normal vector.</span></span><br><span class="line">    output.normal = normalize(output.normal);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Calculate the position of the vertex in the world.</span></span><br><span class="line">    worldPosition = mul(input.position, worldMatrix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine the light position based on the position of the light and the position of the vertex in the world.</span></span><br><span class="line">    output.lightPos = lightPosition.xyz - worldPosition.xyz;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Normalize the light position vector.</span></span><br><span class="line">    output.lightPos = normalize(output.lightPos);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在像素着色器中我们读出投影到当前像素的深度图中的深度，然后使用变换后的相对于光源的坐标来得到相对于光源的深度，然后进行比较，当深度小于深度图中深度的时候我们对他进行正常光照，相反则只进行环境光计算，达到阴影效果。像素着色器中代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Filename: shadow.ps</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line"><span class="comment">// TEXTURES //</span></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line">Texture2D shaderTexture : <span class="keyword">register</span>(t0);</span><br><span class="line">Texture2D depthMapTexture : <span class="keyword">register</span>(t1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////</span></span><br><span class="line"><span class="comment">// SAMPLE STATES //</span></span><br><span class="line"><span class="comment">///////////////////</span></span><br><span class="line">SamplerState SampleTypeClamp : <span class="keyword">register</span>(s0);</span><br><span class="line">SamplerState SampleTypeWrap  : <span class="keyword">register</span>(s1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////</span></span><br><span class="line"><span class="comment">// CONSTANT BUFFERS //</span></span><br><span class="line"><span class="comment">//////////////////////</span></span><br><span class="line">cbuffer LightBuffer</span><br><span class="line">&#123;</span><br><span class="line">	float4 ambientColor;</span><br><span class="line">	float4 diffuseColor;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line"><span class="comment">// TYPEDEFS //</span></span><br><span class="line"><span class="comment">//////////////</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PixelInputType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float2 tex : TEXCOORD0;</span><br><span class="line">	float3 normal : NORMAL;</span><br><span class="line">    float4 lightViewPosition : TEXCOORD1;</span><br><span class="line">	float3 lightPos : TEXCOORD2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Pixel Shader</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">float4 ShadowPixelShader(PixelInputType input) : SV_TARGET</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">float</span> bias;</span><br><span class="line">    float4 color;</span><br><span class="line">	float2 projectTexCoord;</span><br><span class="line">	<span class="keyword">float</span> depthValue;</span><br><span class="line">	<span class="keyword">float</span> lightDepthValue;</span><br><span class="line">    <span class="keyword">float</span> lightIntensity;</span><br><span class="line">	float4 textureColor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the bias value for fixing the floating point precision issues.</span></span><br><span class="line">	bias = <span class="number">0.001f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the default output color to the ambient light value for all pixels.</span></span><br><span class="line">    color = ambientColor;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Calculate the projected texture coordinates.</span></span><br><span class="line">	projectTexCoord.x =  input.lightViewPosition.x / input.lightViewPosition.w / <span class="number">2.0f</span> + <span class="number">0.5f</span>;</span><br><span class="line">	projectTexCoord.y = -input.lightViewPosition.y / input.lightViewPosition.w / <span class="number">2.0f</span> + <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Determine if the projected coordinates are in the 0 to 1 range.  If so then this pixel is in the view of the light.</span></span><br><span class="line">	<span class="keyword">if</span>((saturate(projectTexCoord.x) == projectTexCoord.x) &amp;&amp; (saturate(projectTexCoord.y) == projectTexCoord.y))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Sample the shadow map depth value from the depth texture using the sampler at the projected texture coordinate location.</span></span><br><span class="line">		depthValue = depthMapTexture.Sample(SampleTypeClamp, projectTexCoord).r;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Calculate the depth of the light.</span></span><br><span class="line">		lightDepthValue = input.lightViewPosition.z / input.lightViewPosition.w;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Subtract the bias from the lightDepthValue.</span></span><br><span class="line">		lightDepthValue = lightDepthValue - bias;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Compare the depth of the shadow map value and the depth of the light to determine whether to shadow or to light this pixel.</span></span><br><span class="line">		<span class="comment">// If the light is in front of the object then light the pixel, if not then shadow this pixel since an object (occluder) is casting a shadow on it.</span></span><br><span class="line">		<span class="keyword">if</span>(lightDepthValue &lt; depthValue)</span><br><span class="line">		&#123;</span><br><span class="line">		    <span class="comment">// Calculate the amount of light on this pixel.</span></span><br><span class="line">			lightIntensity = saturate(dot(input.normal, input.lightPos));</span><br><span class="line"></span><br><span class="line">		    <span class="keyword">if</span>(lightIntensity &gt; <span class="number">0.0f</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Determine the final diffuse color based on the diffuse color and the amount of light intensity.</span></span><br><span class="line">				color += (diffuseColor * lightIntensity);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Saturate the final light color.</span></span><br><span class="line">				color = saturate(color);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sample the pixel color from the texture using the sampler at this texture coordinate location.</span></span><br><span class="line">	textureColor = shaderTexture.Sample(SampleTypeWrap, input.tex);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Combine the light and texture color.</span></span><br><span class="line">	color = color * textureColor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;<em>关于光照，投影映射我们之前的文章中都有介绍。</em></p>
<p>&emsp;&emsp;Shadow shader 对应的着色器类也仅仅是缓冲的不同，我们依旧只列出其类声明，具体实现可以参考源码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Class name: ShadowShaderClass</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShadowShaderClass</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MatrixBufferType</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		DirectX::XMMATRIX world;</span><br><span class="line">		DirectX::XMMATRIX view;</span><br><span class="line">		DirectX::XMMATRIX projection;</span><br><span class="line">		DirectX::XMMATRIX lightView;</span><br><span class="line">		DirectX::XMMATRIX lightProjection;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">LightBufferType</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		DirectX::XMFLOAT4 ambientColor;</span><br><span class="line">		DirectX::XMFLOAT4 diffuseColor;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">LightBufferType2</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		DirectX::XMFLOAT3 lightPosition;</span><br><span class="line">		<span class="keyword">float</span> padding;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	ShadowShaderClass();</span><br><span class="line">	ShadowShaderClass(<span class="keyword">const</span> ShadowShaderClass&amp;);</span><br><span class="line">	~ShadowShaderClass();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">(ID3D11Device*, HWND)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Shutdown</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">Render</span><span class="params">(ID3D11DeviceContext*, <span class="keyword">int</span>, DirectX::XMMATRIX, DirectX::XMMATRIX, DirectX::XMMATRIX, DirectX::XMMATRIX, DirectX::XMMATRIX, ID3D11ShaderResourceView*, </span></span></span><br><span class="line"><span class="function"><span class="params">				ID3D11ShaderResourceView*, DirectX::XMFLOAT3, DirectX::XMFLOAT4, DirectX::XMFLOAT4)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">InitializeShader</span><span class="params">(ID3D11Device*, HWND, CHAR*, CHAR*)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ShutdownShader</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OutputShaderErrorMessage</span><span class="params">(ID3D10Blob*, HWND, CHAR*)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">SetShaderParameters</span><span class="params">(ID3D11DeviceContext*, DirectX::XMMATRIX, DirectX::XMMATRIX, DirectX::XMMATRIX, DirectX::XMMATRIX, DirectX::XMMATRIX, ID3D11ShaderResourceView*, </span></span></span><br><span class="line"><span class="function"><span class="params">							 ID3D11ShaderResourceView*, DirectX::XMFLOAT3, DirectX::XMFLOAT4, DirectX::XMFLOAT4)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">RenderShader</span><span class="params">(ID3D11DeviceContext*, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	ID3D11VertexShader* m_vertexShader;</span><br><span class="line">	ID3D11PixelShader* m_pixelShader;</span><br><span class="line">	ID3D11InputLayout* m_layout;</span><br><span class="line">	ID3D11SamplerState* m_sampleStateWrap;</span><br><span class="line">	ID3D11SamplerState* m_sampleStateClamp;</span><br><span class="line">	ID3D11Buffer* m_matrixBuffer;</span><br><span class="line">	ID3D11Buffer* m_lightBuffer;</span><br><span class="line">	ID3D11Buffer* m_lightBuffer2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在 <code>GraphicsClass</code> 中我们首先通过 <code>DepthShaderClass</code> 对象将深度信息绘制进纹理中，然后再使用 <code>ShadowShaderClass</code> 对象进行渲染，部分代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> GraphicsClass::Frame(<span class="keyword">float</span> posX, <span class="keyword">float</span> posY, <span class="keyword">float</span> posZ, <span class="keyword">float</span> rotX, <span class="keyword">float</span> rotY, <span class="keyword">float</span> rotZ)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">bool</span> result;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">float</span> lightPositionX = <span class="number">-5.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the position of the camera.</span></span><br><span class="line">	m_Camera-&gt;SetPosition(posX, posY, posZ);</span><br><span class="line">	m_Camera-&gt;SetRotation(rotX, rotY, rotZ);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update the position of the light each frame.</span></span><br><span class="line">	lightPositionX += <span class="number">0.05f</span>;</span><br><span class="line">	<span class="keyword">if</span>(lightPositionX &gt; <span class="number">5.0f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		lightPositionX = <span class="number">-5.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update the position of the light.</span></span><br><span class="line">	m_Light-&gt;SetPosition(lightPositionX, <span class="number">8.0f</span>, <span class="number">-5.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Render the graphics scene.</span></span><br><span class="line">	result = Render();</span><br><span class="line">	<span class="keyword">if</span>(!result)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们设计了一个在场景上方缓缓移动的光源，这样我们可以看到阴影的变化，某一刻的效果如下：</p>
<p><img src="https://image.ibb.co/ezrs9H/image.png" alt="2"></p>
<p>&emsp;&emsp;源代码：<a href="https://github.com/KsGin/DX11Tutorial/tree/master/DX11Tutorial-ShadowMapping" target="_blank" rel="noopener">DX11Tutorial-ShadowMapping</a></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Computer-graphics/" rel="tag"> Computer graphics</a>
          
            <a href="/tags/DirectX/" rel="tag"> DirectX</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/23/【图形学基础算法】贰-DDA法生成直线/" rel="next" title="【图形学基础算法】贰-DDA法生成直线">
                <i class="fa fa-chevron-left"></i> 【图形学基础算法】贰-DDA法生成直线
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/24/【DirectX】43-多光源阴影映射/" rel="prev" title="【DirectX】43-多光源阴影映射">
                【DirectX】43-多光源阴影映射 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
  <div id="gitalk-container">
  </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://i.loli.net/2017/12/11/5a2ded5692edd.jpg"
                alt="KsGin" />
            
              <p class="site-author-name" itemprop="name">KsGin</p>
              <p class="site-description motion-element" itemprop="description">我喜欢你，真的</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">225</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/KsGin" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:imqqyangfan@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://plus.google.com/u/0/101361480125270592603" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i>Google</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/JoiJoker" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#参考教程"><span class="nav-number">1.</span> <span class="nav-text">参考教程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#学习记录"><span class="nav-number">2.</span> <span class="nav-text">学习记录</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">KsGin @ 2018</span>

  

  
</div>











        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
























  



  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.6"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.6"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.6"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.6"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.6"></script>



  



	





  





  










  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   <script type="text/javascript">
		var gitalk = new Gitalk({
		  clientID: '4fe20a82e7e8045e841a',
		  clientSecret: '74129f3236c623b7271aeb8ed4dacd990f5ef384',
		  repo: 'ksgin.github.io',
		  owner: 'ksgin',
		  admin: ['ksgin'], 
		  id: '【DirectX】42-阴影映射',
		  distractionFreeMode: 'true'
		})
		gitalk.render('gitalk-container')           
       </script>


  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->





  

  

  

  
  

  
  

  


  
  

  

  

  

  

</body>
</html>
